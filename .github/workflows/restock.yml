name: Japan Blue Restock Watch

on:
  schedule:
    - cron: '*/15 * * * *'  # Every 15 minutes (UTC)
  workflow_dispatch:  # Allow manual runs

permissions:
  contents: write

concurrency:
  group: japanblue-restock
  cancel-in-progress: false

jobs:
  check-restock:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 python-dotenv

      - name: Run restock checker
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          python japanblue_restock_watch.py

      - name: Commit updated state (if changed)
        run: |
          # Only commit if restock_state.json changed
          if git status --porcelain | grep -q "restock_state.json"; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add restock_state.json
            git commit -m "Update restock watcher state"
            git push
          else
            echo "No state changes to commit."
          fi

      - name: Notify on failure
        if: failure()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -n "$DISCORD_WEBHOOK_URL" ]; then
            python3 << 'EOF'
          import os
          import json
          import urllib.request
          import urllib.error
          
          webhook_url = os.environ.get("DISCORD_WEBHOOK_URL")
          if webhook_url:
              workflow_url = f"{os.environ.get('GITHUB_SERVER_URL', 'https://github.com')}/{os.environ.get('GITHUB_REPOSITORY')}/actions/runs/{os.environ.get('GITHUB_RUN_ID')}"
              
              content = (
                  "âŒ **Japan Blue Restock Watcher Failed**\n\n"
                  "The GitHub Actions workflow encountered an error.\n"
                  "This could be due to:\n"
                  "- Network/URL connectivity issues\n"
                  "- Website changes\n"
                  "- Script errors\n\n"
                  f"**Workflow Run:** {workflow_url}"
              )
              
              payload = json.dumps({"content": content})
              data = payload.encode('utf-8')
              
              try:
                  req = urllib.request.Request(
                      webhook_url,
                      data=data,
                      headers={'Content-Type': 'application/json'}
                  )
                  with urllib.request.urlopen(req, timeout=10) as response:
                      print("Discord failure notification sent successfully")
              except Exception as e:
                  print(f"Failed to send Discord notification: {e}")
          EOF
          else
            echo "DISCORD_WEBHOOK_URL not set, skipping failure notification"
          fi

